# SanguiBlog V2.1.275 发布说明

> **版本性质**：增量更新（相对 `V2.1.249`）  
> **文档生成日期**：2026-01-02  
> **站点版本号来源**：后端 `SanguiBlog-server/src/main/resources/application.yaml` 的 `site.version`，前端首页 Banner 展示 `SANGUI BLOG // <version>`  
> **说明**：`V2.1.250 ~ V2.1.275` 期间包含大量迭代与修复，本文仅汇总“对外可感知且重要”的变化；更细粒度的逐版本明细请查看根目录 `AGENTS-EDIT.md`。

## 1. 版本亮点

- **站点地图（SEO）增强**：`/sitemap.xml` 支持 URL 规模超阈值自动返回 `<sitemapindex>`，并通过 `page` 参数分片拉取（`/sitemap.xml?page=1..N`），降低单文件上限风险；同时为 `/sitemap.xml` 与 `/robots.txt` 增加 `ETag/If-None-Match`，命中返回 304 以降低爬虫重复抓取成本。
- **文章目录体验提升**：文章详情页目录在桌面侧栏与移动抽屉同步增强，新增更清晰的层级展示（树形引导线），并加入 ScrollSpy（滚动阅读时自动高亮当前章节并自动跟随定位）。
- **文章图片预览更“像查看器”**：预览层支持鼠标滚轮缩放（放大/缩小）与放大后的拖拽平移，同时移除右上角“关闭”按钮（再次点击图片/遮罩即可关闭），交互更统一。

## 2. 主要变更（摘要）

### 2.1 SEO 与抓取

- **站点地图分片/索引**
  - 当 URL 数量超过阈值时，`GET /sitemap.xml` 返回 `<sitemapindex>`。
  - 分片 sitemap 通过 `GET /sitemap.xml?page=1..N` 获取（仍是同一路径，仅 query 参数变化，部署层通常无需新增 Nginx 规则）。
- **条件请求与缓存**
  - `/sitemap.xml` 与 `/robots.txt` 支持 `ETag/If-None-Match`，命中时返回 304。
- **robots 规则收敛**
  - `robots.txt` 默认禁止抓取 `/admin` 与 `/api/`，避免后台与接口被误收录。

### 2.2 文章详情页（/article/:id）

- **目录浮层**
  - 层级展示升级为树形引导线（更直观区分 h1/h2/h3）。
  - 新增 ScrollSpy：滚动时自动高亮当前章节，并在目录滚动区域自动跟随定位（桌面侧栏与移动抽屉同步生效）。
  - 暗色模式下目录滚动条轨道背景修复（避免白色轨道影响观感）。
- **图片预览**
  - 修复浏览器缩放场景下的“放大反而变小”的观感问题（改为基于 `vw/vh` 的约束尺寸，避免 padding 挤压可视区）。
  - 支持滚轮缩放 + 放大后拖拽平移。
  - 移除右上角关闭按钮，统一为再次点击图片/遮罩关闭。

## 3. 配置变更与环境变量

### 3.1 新增配置项

- `site.sitemap.max-urls-per-file`：单个 sitemap 文件最大 URL 数（默认 `45000`）
  - 对应环境变量：`SITE_SITEMAP_MAX_URLS_PER_FILE`

### 3.2 仍需重点关注的既有项（复核即可）

- `site.base-url` / `site.allowed-hosts`：影响 sitemap/robots 输出域名（同时响应包含 `Vary: Host`）。
- `site.sitemap.cache-ttl-ms` / `site.sitemap.refresh-delay-ms`：站点地图缓存与定时刷新策略。

## 4. 升级与部署建议

1. **后端**：替换部署包并确保配置项（尤其 `site.*`）已按生产环境注入。
2. **前端**：更新构建产物（`dist`）并重新部署静态站点。
3. **Nginx（如使用 SPA 回退）**：
   - 保持 `location = /sitemap.xml` 与 `location = /robots.txt` 优先反代到后端（避免被 `try_files $uri /index.html` 回退吞掉）。
4. **无数据库迁移要求**：本版本摘要所列改动不涉及表结构变更。

## 5. 已知注意事项

- 浏览器控制台出现 `content_script.js`、`chrome-extension://...` 等报错时，大概率来自浏览器扩展注入脚本，与站点功能无关；可通过禁用扩展/无痕窗口快速验证。

