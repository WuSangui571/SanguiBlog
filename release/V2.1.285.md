# SanguiBlog V2.1.285 发布说明

> **版本性质**：增量更新（相对 `V2.1.275`）  
> **文档生成日期**：2026-01-04  
> **站点版本号来源**：后端 `SanguiBlog-server/src/main/resources/application.yaml` 的 `site.version`，前端首页 Banner 展示 `SANGUI BLOG // <version>`  
> **说明**：`V2.1.276 ~ V2.1.285` 期间包含多次迭代与修复，本文聚焦“对外可感知且重要”的变化；更细粒度的逐版本明细请查看 `.ai/CHANGELOG_AI.md`。

## 1. 版本亮点

- **后台数据分析更可用**：访问日志筛选维度更完整（页面类型/关键词/IP/日期区间/登录态等），并修复了“文章访问筛选取反”的历史问题。
- **文章页阅读体验更稳定**：修复上一篇/下一篇跳转偶发报错；摘要支持 Markdown；行内 `code` 在标题/正文/摘要字号与样式更一致。
- **交互可访问性补强**：图片预览与移动端目录抽屉支持 `Esc` 关闭，并做基础焦点管理，键盘用户体验更可靠。

## 2. 主要变更（摘要）

### 2.1 后台数据分析（/admin/analytics）

- **访问日志筛选增强**
  - 新增/完善“页面类型”筛选（文章访问 / 普通页面 / 机器页面（robots/sitemap））。
  - 修复“文章访问”筛选结果反向的问题：应仅返回文章访问日志（对应文章页访问记录）。
- **访问来源可读性**
  - 修复某些场景下来源字段出现 `%E6%...`（URL 编码串）导致不可读的问题（对写入与展示做了兜底解码）。
- **趋势/展示体验**
  - 访客走势图在跨月/跨年窗口下更稳定；展示形态更适合快速判断 PV/UV 异常波动（以仓库实际实现为准）。

### 2.2 文章详情页（/article/:id）

- **上一篇/下一篇跳转稳定性**
  - 修复切换前后篇时浏览器 `fetch` 因 header 字符集限制导致的偶发报错（无需刷新即可稳定打开）。
- **摘要支持 Markdown**
  - 摘要中的行内代码/高亮等 Markdown 语法可正常渲染。
- **行内 code（`xxx`）一致性**
  - 标题/正文/摘要中行内 `code` 的字号与容器字号一致（不再出现“标题 code 偏小、正文 code 偏小”等观感问题）。
  - Markdown 渲染路径与 HTML 兜底渲染路径的行内 `code` 样式更一致。
- **可访问性**
  - 图片预览支持 `Esc` 关闭并恢复焦点；移动端目录抽屉支持 `Esc` 关闭并聚焦关闭按钮。

## 3. 数据库变更与升级建议

> 项目采用 `spring.jpa.hibernate.ddl-auto: none`，数据库结构不会自动更新。

- **访问日志按日归档表（防爆表）**
  - 新增表：`analytics_page_view_daily_stats`（用于沉淀历史 PV/UV 的日聚合）。
  - 说明：初始化脚本 `sanguiblog_db.sql` 已包含该表；若你从旧版本升级，请手动将该表结构补齐。

## 4. 配置变更与环境变量

- 访问日志归档/清理相关配置：`analytics.page-views.archive.*` / `analytics.page-views.cleanup.*`（默认可保持关闭；如需启用请在生产环境评估后开启）。
- 其它配置沿用 `V2.1.275` 的部署建议与约束（例如 sitemap/robots 的 Nginx 精确反代规则）。

## 5. 升级与部署建议

1. **后端**
   - 替换 Jar 包并复核 `application.yaml` 的关键配置（数据库/JWT/上传目录/站点域名等）。
   - 若是从旧版本升级，按第 3 节补齐数据库表结构。
2. **前端**
   - 重新构建并部署 `SanguiBlog-front/dist/`。
3. **验证建议（人工即可）**
   - 文章页切换上一篇/下一篇不报错，摘要 Markdown 可用。
   - 后台 `/admin/analytics`：页面类型“文章访问”筛选结果正确，流量来源不出现 `%E6%...`。

## 6. 已知注意事项

- 若浏览器控制台出现 `content_script.js`、`chrome-extension://...` 等报错，多为浏览器扩展注入脚本噪声，与站点功能无关；可通过无痕窗口/禁用扩展验证。

